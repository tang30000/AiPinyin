//! # 拼音解析引擎
//!
//! 将连续的英文字母按拼音规则切分为音节，
//! 并提供基础的拼音→汉字候选查找能力。
//!
//! ## 设计理念
//! 目前使用规则切分 + 静态候选表作为骨架，
//! 后续将替换为 AI 向量推理引擎。


// ============================================================
// 拼音合法音节表（完整声母+韵母组合）
// ============================================================

/// 所有合法拼音音节（不含声调）
const VALID_SYLLABLES: &[&str] = &[
    // 单韵母
    "a", "o", "e", "ai", "ei", "ao", "ou", "an", "en", "ang", "eng", "er",
    // b
    "ba", "bo", "bi", "bu", "bai", "bei", "bao", "ban", "ben", "bang", "beng",
    "bie", "biao", "bian", "bin", "bing",
    // p
    "pa", "po", "pi", "pu", "pai", "pei", "pao", "pou", "pan", "pen", "pang", "peng",
    "pie", "piao", "pian", "pin", "ping",
    // m
    "ma", "mo", "me", "mi", "mu", "mai", "mei", "mao", "mou", "man", "men",
    "mang", "meng", "mie", "miao", "miu", "mian", "min", "ming",
    // f
    "fa", "fo", "fu", "fei", "fou", "fan", "fen", "fang", "feng",
    // d
    "da", "de", "di", "du", "dai", "dei", "dao", "dou", "dan", "den", "dang", "deng",
    "dong", "die", "diao", "diu", "dian", "ding", "duo", "dui", "duan", "dun",
    // t
    "ta", "te", "ti", "tu", "tai", "tao", "tou", "tan", "tang", "teng",
    "tong", "tie", "tiao", "tian", "ting", "tuo", "tui", "tuan", "tun",
    // n
    "na", "ne", "ni", "nu", "nv", "nai", "nei", "nao", "nou", "nan", "nen",
    "nang", "neng", "nong", "nie", "niao", "niu", "nian", "nin", "ning",
    "nuo", "nuan", "nve",
    // l
    "la", "le", "li", "lu", "lv", "lai", "lei", "lao", "lou", "lan", "lang", "leng",
    "long", "lie", "liao", "liu", "lian", "lin", "ling", "luo", "luan", "lun", "lve",
    // g
    "ga", "ge", "gu", "gai", "gei", "gao", "gou", "gan", "gen", "gang", "geng",
    "gong", "gua", "guai", "guan", "guang", "gui", "gun", "guo",
    // k
    "ka", "ke", "ku", "kai", "kei", "kao", "kou", "kan", "ken", "kang", "keng",
    "kong", "kua", "kuai", "kuan", "kuang", "kui", "kun", "kuo",
    // h
    "ha", "he", "hu", "hai", "hei", "hao", "hou", "han", "hen", "hang", "heng",
    "hong", "hua", "huai", "huan", "huang", "hui", "hun", "huo",
    // j
    "ji", "ju", "jia", "jie", "jiao", "jiu", "jian", "jin", "jiang", "jing",
    "jiong", "juan", "jun", "jue",
    // q
    "qi", "qu", "qia", "qie", "qiao", "qiu", "qian", "qin", "qiang", "qing",
    "qiong", "quan", "qun", "que",
    // x
    "xi", "xu", "xia", "xie", "xiao", "xiu", "xian", "xin", "xiang", "xing",
    "xiong", "xuan", "xun", "xue",
    // zh
    "zha", "zhe", "zhi", "zhu", "zhai", "zhei", "zhao", "zhou", "zhan", "zhen",
    "zhang", "zheng", "zhong", "zhua", "zhuai", "zhuan", "zhuang", "zhui", "zhun", "zhuo",
    // ch
    "cha", "che", "chi", "chu", "chai", "chao", "chou", "chan", "chen",
    "chang", "cheng", "chong", "chua", "chuai", "chuan", "chuang", "chui", "chun", "chuo",
    // sh
    "sha", "she", "shi", "shu", "shai", "shei", "shao", "shou", "shan", "shen",
    "shang", "sheng", "shua", "shuai", "shuan", "shuang", "shui", "shun", "shuo",
    // r
    "re", "ri", "ru", "rao", "rou", "ran", "ren", "rang", "reng",
    "rong", "rua", "ruan", "rui", "run", "ruo",
    // z
    "za", "ze", "zi", "zu", "zai", "zei", "zao", "zou", "zan", "zen", "zang", "zeng",
    "zong", "zuo", "zui", "zuan", "zun",
    // c
    "ca", "ce", "ci", "cu", "cai", "cao", "cou", "can", "cen", "cang", "ceng",
    "cong", "cuo", "cui", "cuan", "cun",
    // s
    "sa", "se", "si", "su", "sai", "sao", "sou", "san", "sen", "sang", "seng",
    "song", "suo", "sui", "suan", "sun",
    // y
    "ya", "ye", "yi", "yo", "yu", "yao", "you", "yan", "yin", "yang", "ying",
    "yong", "yuan", "yun", "yue",
    // w
    "wa", "wo", "wu", "wai", "wei", "wan", "wen", "wang", "weng",
];

// ============================================================
// 拼音输入缓冲区
// ============================================================

/// 拼音输入引擎
///
/// 管理用户的按键输入，将字母序列实时解析为拼音音节。
pub struct PinyinEngine {
    /// 原始输入缓冲区（用户敲的字母）
    raw: String,
    /// 解析后的拼音音节
    syllables: Vec<String>,
}

impl PinyinEngine {
    pub fn new() -> Self {
        Self { raw: String::new(), syllables: vec![] }
    }

    /// 输入一个字符（a-z）
    pub fn push(&mut self, ch: char) {
        if ch.is_ascii_lowercase() {
            self.raw.push(ch);
            self.syllables = split_pinyin(&self.raw);
        }
    }

    /// 退格删除最后一个字符
    pub fn pop(&mut self) {
        self.raw.pop();
        self.syllables = if self.raw.is_empty() {
            vec![]
        } else {
            split_pinyin(&self.raw)
        };
    }

    /// 清空所有输入
    pub fn clear(&mut self) {
        self.raw.clear();
        self.syllables.clear();
    }

    /// 获取原始输入
    pub fn raw_input(&self) -> &str { &self.raw }

    /// 获取解析出的拼音音节
    pub fn syllables(&self) -> &[String] { &self.syllables }

    /// 是否为空
    pub fn is_empty(&self) -> bool { self.raw.is_empty() }

    /// 获取候选汉字
    ///
    /// 优先匹配第一个完整音节；若不完整，则用前缀匹配最近的音节。
    pub fn get_candidates(&self) -> Vec<String> {
        if self.raw.is_empty() { return vec![]; }

        let first_syllable = self.syllables.first().map(|s| s.as_str()).unwrap_or(&self.raw);

        // 1. 完整音节直接查表
        let direct = lookup_candidates(first_syllable);
        if !direct.is_empty() { return direct; }

        // 2. 前缀匹配：找到所有以当前输入开头的音节，合并候选
        let prefix = &self.raw[..self.raw.len().min(first_syllable.len())];
        let mut result = Vec::new();
        for syl in VALID_SYLLABLES {
            if syl.starts_with(prefix) {
                let cands = lookup_candidates(syl);
                for c in cands {
                    if !result.contains(&c) { result.push(c); }
                    if result.len() >= 9 { return result; }
                }
            }
        }
        result
    }
}

// ============================================================
// 拼音切分算法 — 贪心最长匹配
// ============================================================

/// 将连续字母序列切分为拼音音节（贪心最长匹配）
///
/// 例如: "nihao" → ["ni", "hao"]
///       "xian"  → ["xian"]（不是 "xi" + "an"）
fn split_pinyin(input: &str) -> Vec<String> {
    let mut result = Vec::new();
    let chars: Vec<char> = input.chars().collect();
    let len = chars.len();
    let mut i = 0;

    while i < len {
        let mut best_len = 0;

        // 从最长可能的音节开始尝试（最长6字符，如 zhuang）
        let max_try = std::cmp::min(6, len - i);
        for try_len in (1..=max_try).rev() {
            let candidate: String = chars[i..i + try_len].iter().collect();
            if is_valid_syllable(&candidate) {
                best_len = try_len;
                break;
            }
        }

        if best_len > 0 {
            let syllable: String = chars[i..i + best_len].iter().collect();
            result.push(syllable);
            i += best_len;
        } else {
            // 无法匹配，单独放一个字符（部分输入）
            result.push(chars[i].to_string());
            i += 1;
        }
    }

    result
}

/// 检查是否为合法拼音音节
fn is_valid_syllable(s: &str) -> bool {
    VALID_SYLLABLES.binary_search(&s).is_ok()
        || VALID_SYLLABLES.contains(&s)
}

// ============================================================
// 临时候选查找（后续替换为 AI 推理）
// ============================================================

/// 基础拼音→汉字候选映射
///
/// 这是一个临时方案，提供常用字的基础候选。
/// 正式版本将使用 ONNX 向量推理引擎替代。
fn lookup_candidates(syllable: &str) -> Vec<String> {
    let candidates: &[&str] = match syllable {
        "a"    => &["啊", "阿", "呵", "嗄", "腌"],
        "ai"   => &["爱", "哎", "唉", "埃", "挨", "碍", "矮", "癌"],
        "an"   => &["安", "按", "案", "暗", "岸", "俺", "谙"],
        "ang"  => &["昂", "盎"],
        "ao"   => &["奥", "凹", "熬", "敖", "遨", "傲", "澳"],
        "ba"   => &["吧", "八", "把", "爸", "拔", "罢", "坝", "巴"],
        "bai"  => &["白", "百", "败", "拜", "摆", "柏", "伯"],
        "ban"  => &["办", "半", "班", "般", "版", "板", "伴", "扮"],
        "bang"  => &["帮", "棒", "榜", "膀", "绑", "磅"],
        "bei"  => &["被", "北", "背", "备", "杯", "悲", "辈", "碑"],
        "ben"  => &["本", "奔", "笨", "苯"],
        "bi"   => &["比", "笔", "必", "逼", "鼻", "壁", "避", "闭"],
        "bian" => &["变", "边", "便", "遍", "编", "辩", "辨", "鞭"],
        "biao" => &["表", "标", "彪", "镖", "膘"],
        "bie"  => &["别", "憋", "鳖"],
        "bing" => &["并", "病", "冰", "兵", "饼", "丙", "柄"],
        "bu"   => &["不", "步", "部", "布", "补", "捕", "堡"],
        "ca"   => &["擦", "嚓"],
        "cai"  => &["才", "菜", "采", "彩", "财", "材", "裁", "猜"],
        "can"  => &["参", "残", "惨", "灿", "蚕", "惭"],
        "ce"   => &["策", "测", "侧", "册", "厕"],
        "cha"  => &["查", "差", "茶", "插", "察", "叉"],
        "chang"=> &["长", "常", "场", "唱", "厂", "昌", "尝", "偿"],
        "che"  => &["车", "扯", "彻", "撤", "尘"],
        "chi"  => &["吃", "迟", "持", "池", "尺", "赤", "翅", "斥"],
        "chong"=> &["重", "冲", "充", "虫", "崇", "宠"],
        "chu"  => &["出", "处", "初", "除", "楚", "触", "储", "础"],
        "ci"   => &["次", "此", "词", "刺", "磁", "瓷", "辞"],
        "da"   => &["大", "打", "达", "答", "搭"],
        "dai"  => &["带", "代", "大", "待", "袋", "戴", "呆"],
        "dan"  => &["但", "单", "蛋", "担", "淡", "弹", "胆", "旦"],
        "dang" => &["当", "党", "档", "挡", "荡"],
        "dao"  => &["到", "道", "刀", "倒", "导", "岛", "盗"],
        "de"   => &["的", "得", "德", "地"],
        "deng" => &["等", "灯", "登", "邓"],
        "di"   => &["的", "地", "第", "低", "底", "抵", "敌", "帝"],
        "dian" => &["点", "电", "店", "典", "垫", "殿", "淀"],
        "ding" => &["定", "顶", "丁", "订", "钉", "鼎"],
        "dong" => &["动", "东", "冬", "懂", "洞", "董", "冻"],
        "dou"  => &["都", "斗", "豆", "抖", "逗", "窦"],
        "du"   => &["都", "度", "读", "独", "毒", "堵", "赌", "杜"],
        "dui"  => &["对", "队", "堆", "兑"],
        "duo"  => &["多", "朵", "夺", "躲", "堕"],
        "en"   => &["恩", "嗯"],
        "er"   => &["二", "而", "耳", "儿", "尔"],
        "fa"   => &["发", "法", "罚", "伐", "阀", "乏"],
        "fan"  => &["反", "饭", "犯", "翻", "番", "烦", "范", "贩"],
        "fang" => &["方", "放", "房", "防", "访", "仿", "芳"],
        "fei"  => &["非", "飞", "费", "废", "肥", "匪", "肺"],
        "fen"  => &["分", "份", "粉", "奋", "愤", "坟", "纷"],
        "feng" => &["风", "丰", "封", "峰", "锋", "疯", "蜂", "逢"],
        "fu"   => &["不", "服", "福", "府", "副", "夫", "复", "付", "负", "富"],
        "ga"   => &["嘎", "噶"],
        "gai"  => &["该", "改", "盖", "概", "钙"],
        "gan"  => &["干", "感", "敢", "赶", "甘", "肝", "杆"],
        "gang" => &["刚", "钢", "岗", "港", "纲", "缸"],
        "gao"  => &["高", "告", "搞", "稿", "糕"],
        "ge"   => &["个", "各", "歌", "格", "隔", "革", "割", "哥"],
        "gei"  => &["给"],
        "gen"  => &["跟", "根", "更"],
        "gong" => &["工", "公", "共", "功", "供", "攻", "宫", "弓"],
        "gou"  => &["够", "狗", "沟", "勾", "构", "购", "钩"],
        "gu"   => &["古", "故", "谷", "骨", "鼓", "股", "固", "顾"],
        "gua"  => &["挂", "瓜", "刮", "寡", "卦"],
        "guan" => &["关", "管", "官", "观", "馆", "冠", "灌", "贯"],
        "guang"=> &["光", "广", "逛"],
        "gui"  => &["归", "贵", "鬼", "规", "柜", "桂", "轨"],
        "guo"  => &["国", "过", "果", "锅", "裹"],
        "ha"   => &["哈", "蛤"],
        "hai"  => &["还", "海", "害", "孩", "嗨"],
        "han"  => &["汉", "含", "喊", "寒", "韩", "汗", "函"],
        "hao"  => &["好", "号", "毫", "豪", "耗", "浩"],
        "he"   => &["和", "何", "河", "合", "核", "喝", "贺", "赫"],
        "hei"  => &["黑", "嘿"],
        "hen"  => &["很", "恨", "狠", "痕"],
        "heng" => &["横", "衡", "恒", "哼"],
        "hong" => &["红", "洪", "宏", "轰", "烘", "虹", "鸿"],
        "hou"  => &["后", "候", "厚", "猴", "吼", "侯"],
        "hu"   => &["胡", "湖", "虎", "呼", "互", "户", "护", "忽"],
        "hua"  => &["话", "花", "化", "华", "画", "划", "滑"],
        "huai" => &["坏", "怀", "淮"],
        "huan" => &["还", "换", "欢", "环", "患", "幻", "唤"],
        "huang"=> &["黄", "皇", "荒", "慌", "晃", "恍", "煌"],
        "hui"  => &["会", "回", "灰", "挥", "辉", "汇", "毁", "慧"],
        "huo"  => &["活", "火", "或", "获", "货", "祸", "伙"],
        "ji"   => &["几", "机", "已", "记", "级", "及", "基", "集", "技", "计"],
        "jia"  => &["家", "加", "假", "价", "甲", "驾", "嫁", "架"],
        "jian" => &["见", "间", "件", "建", "剑", "减", "渐", "简", "检", "健"],
        "jiang"=> &["将", "江", "讲", "奖", "降", "酱", "姜"],
        "jiao" => &["叫", "教", "交", "角", "脚", "较", "骄", "浇"],
        "jie"  => &["就", "姐", "接", "结", "解", "介", "界", "届", "借", "节"],
        "jin"  => &["进", "近", "金", "今", "禁", "仅", "紧", "尽", "劲"],
        "jing" => &["经", "精", "京", "景", "境", "镜", "竞", "静", "惊", "净"],
        "jiu"  => &["就", "九", "久", "酒", "旧", "救", "究"],
        "ju"   => &["就", "举", "句", "具", "居", "局", "距", "巨"],
        "juan" => &["卷", "倦", "圈", "绢", "捐"],
        "jue"  => &["觉", "决", "绝", "角", "掘", "爵"],
        "jun"  => &["军", "均", "君", "俊", "菌"],
        "ka"   => &["卡", "喀", "咖"],
        "kai"  => &["开", "凯", "慨", "揩"],
        "kan"  => &["看", "砍", "刊", "勘", "堪"],
        "ke"   => &["可", "课", "科", "克", "客", "刻", "颗", "壳"],
        "ken"  => &["肯", "垦", "恳", "啃"],
        "kong" => &["空", "孔", "控", "恐"],
        "kou"  => &["口", "扣", "寇", "叩"],
        "ku"   => &["苦", "哭", "库", "裤", "酷", "枯"],
        "kuai" => &["快", "块", "筷", "会"],
        "kuan" => &["宽", "款"],
        "kuang"=> &["况", "狂", "矿", "框", "旷"],
        "la"   => &["拉", "啦", "辣", "蜡"],
        "lai"  => &["来", "赖", "莱"],
        "lan"  => &["蓝", "烂", "兰", "拦", "栏", "懒", "览"],
        "lang" => &["浪", "郎", "朗", "狼", "廊"],
        "lao"  => &["老", "劳", "牢", "捞", "姥"],
        "le"   => &["了", "乐", "勒"],
        "lei"  => &["类", "累", "泪", "雷", "蕾", "磊"],
        "leng" => &["冷", "愣", "楞"],
        "li"   => &["里", "力", "理", "利", "立", "例", "历", "李", "离", "礼"],
        "lian" => &["连", "联", "练", "脸", "链", "恋", "帘"],
        "liang"=> &["两", "量", "亮", "良", "粮", "凉", "梁"],
        "liao" => &["了", "料", "聊", "疗", "辽", "廖"],
        "lie"  => &["列", "烈", "裂", "猎", "劣"],
        "lin"  => &["林", "临", "淋", "邻", "磷", "凛"],
        "ling" => &["令", "另", "灵", "零", "领", "岭", "铃", "凌"],
        "liu"  => &["六", "流", "留", "刘", "柳", "溜"],
        "long" => &["龙", "弄", "隆", "笼", "聋", "拢"],
        "lu"   => &["路", "录", "陆", "鲁", "卢", "露", "炉", "绿"],
        "lv"   => &["绿", "旅", "律", "虑", "率", "滤", "吕"],
        "ma"   => &["吗", "妈", "马", "么", "麻", "骂", "码"],
        "mai"  => &["买", "卖", "麦", "迈", "埋", "脉"],
        "man"  => &["满", "慢", "漫", "蛮", "瞒"],
        "mang" => &["忙", "盲", "茫", "芒"],
        "mei"  => &["没", "美", "每", "梅", "妹", "媒", "煤", "眉"],
        "men"  => &["们", "门", "闷"],
        "mi"   => &["米", "秘", "密", "迷", "蜜", "谜", "觅"],
        "mian" => &["面", "免", "棉", "眠", "绵", "缅"],
        "ming" => &["明", "名", "命", "鸣", "铭", "冥"],
        "mo"   => &["么", "末", "默", "莫", "模", "磨", "摸", "墨"],
        "mu"   => &["目", "木", "母", "幕", "牧", "墓", "暮", "慕"],
        "na"   => &["那", "拿", "哪", "纳", "呐"],
        "nai"  => &["乃", "奶", "耐", "奈"],
        "nan"  => &["南", "男", "难", "楠"],
        "ne"   => &["呢", "讷"],
        "nei"  => &["内", "那"],
        "neng" => &["能"],
        "ni"   => &["你", "泥", "拟", "逆", "腻"],
        "nian" => &["年", "念", "娘", "粘", "碾"],
        "niang"=> &["娘", "酿"],
        "ning" => &["宁", "凝", "拧", "柠"],
        "niu"  => &["牛", "扭", "纽", "钮"],
        "nong" => &["农", "浓", "弄"],
        "nu"   => &["女", "努", "怒", "奴"],
        "nv"   => &["女"],
        "pa"   => &["怕", "爬", "帕", "拍"],
        "pang" => &["旁", "胖", "庞", "磅"],
        "pei"  => &["配", "陪", "佩", "培", "赔"],
        "pi"   => &["批", "皮", "屁", "脾", "匹", "劈", "偏"],
        "pian" => &["片", "偏", "篇", "骗", "翩"],
        "ping" => &["平", "评", "瓶", "凭", "屏"],
        "po"   => &["破", "坡", "迫", "泼", "婆", "颇"],
        "pu"   => &["普", "铺", "朴", "扑", "浦", "谱", "蒲"],
        "qi"   => &["起", "其", "气", "七", "期", "器", "奇", "齐", "企", "启"],
        "qian" => &["前", "千", "钱", "签", "浅", "潜", "牵", "铅", "嵌"],
        "qiang"=> &["强", "墙", "枪", "抢", "腔"],
        "qiao" => &["桥", "巧", "敲", "瞧", "悄", "翘"],
        "qin"  => &["亲", "琴", "勤", "侵", "秦", "寝"],
        "qing" => &["请", "清", "情", "青", "轻", "庆", "倾", "晴"],
        "qu"   => &["去", "取", "区", "趣", "曲", "娶", "渠"],
        "quan" => &["全", "权", "劝", "泉", "拳", "圈"],
        "que"  => &["却", "确", "缺", "雀", "瘸"],
        "ran"  => &["然", "染", "燃"],
        "rang" => &["让", "嚷", "壤"],
        "re"   => &["热", "惹"],
        "ren"  => &["人", "认", "任", "忍", "仁", "刃"],
        "ri"   => &["日"],
        "rong" => &["容", "融", "荣", "溶", "绒"],
        "ru"   => &["如", "入", "乳", "儒", "辱"],
        "san"  => &["三", "散", "伞"],
        "se"   => &["色", "涩", "瑟"],
        "sha"  => &["杀", "沙", "傻", "啥", "纱", "砂"],
        "shan" => &["山", "善", "扇", "闪", "衫", "珊", "删"],
        "shang"=> &["上", "商", "伤", "赏", "尚", "裳"],
        "shao" => &["少", "绍", "烧", "稍", "邵", "勺"],
        "she"  => &["社", "设", "舍", "射", "蛇", "涉", "摄"],
        "shei" => &["谁"],
        "shen" => &["什", "深", "身", "神", "甚", "审", "沈", "伸", "慎"],
        "sheng"=> &["生", "声", "省", "胜", "圣", "盛", "剩", "升"],
        "shi"  => &["是", "时", "十", "事", "实", "使", "世", "市", "石", "师"],
        "shou" => &["手", "收", "首", "受", "守", "寿", "授", "瘦"],
        "shu"  => &["书", "数", "树", "术", "属", "输", "熟", "束", "鼠", "叔"],
        "shua" => &["刷", "耍"],
        "shuai"=> &["帅", "摔", "衰", "甩"],
        "shui" => &["水", "睡", "谁", "税"],
        "shuo" => &["说", "硕", "朔"],
        "si"   => &["四", "死", "思", "似", "丝", "寺", "私", "司"],
        "song" => &["送", "松", "宋", "诵", "颂"],
        "su"   => &["苏", "速", "素", "俗", "诉", "宿", "塑"],
        "suan" => &["算", "酸", "蒜"],
        "sui"  => &["随", "虽", "岁", "碎", "遂", "穗"],
        "sun"  => &["孙", "损", "笋"],
        "suo"  => &["所", "锁", "缩", "索"],
        "ta"   => &["他", "她", "它", "踏", "塔", "塌"],
        "tai"  => &["太", "台", "态", "泰", "抬", "胎"],
        "tan"  => &["谈", "弹", "坦", "探", "叹", "摊", "贪", "碳"],
        "tang" => &["堂", "唐", "糖", "汤", "躺", "趟", "烫"],
        "tao"  => &["套", "逃", "桃", "讨", "陶", "淘"],
        "te"   => &["特"],
        "teng" => &["疼", "腾", "藤"],
        "ti"   => &["题", "提", "体", "替", "踢", "剃"],
        "tian" => &["天", "田", "甜", "填", "添"],
        "tiao" => &["条", "跳", "调", "挑"],
        "ting" => &["听", "停", "厅", "挺", "庭", "亭"],
        "tong" => &["同", "通", "痛", "统", "铜", "童", "桶"],
        "tou"  => &["头", "投", "透", "偷"],
        "tu"   => &["土", "图", "突", "途", "吐", "兔", "涂"],
        "tui"  => &["退", "推", "腿", "蜕"],
        "tuo"  => &["拖", "脱", "托", "妥", "驼"],
        "wa"   => &["挖", "娃", "瓦", "哇", "袜"],
        "wan"  => &["万", "完", "晚", "玩", "碗", "弯", "湾"],
        "wang" => &["王", "网", "往", "望", "忘", "汪"],
        "wei"  => &["为", "位", "未", "味", "微", "围", "伟", "维", "委", "卫"],
        "wen"  => &["问", "文", "温", "闻", "稳", "吻", "纹"],
        "wo"   => &["我", "握", "窝", "卧"],
        "wu"   => &["五", "无", "物", "务", "武", "午", "舞", "误", "屋", "吴"],
        "xi"   => &["西", "系", "希", "习", "细", "席", "洗", "喜", "戏", "吸"],
        "xia"  => &["下", "夏", "吓", "虾", "瞎", "霞", "峡"],
        "xian" => &["先", "现", "线", "限", "显", "县", "鲜", "险", "献", "仙"],
        "xiang"=> &["想", "向", "像", "相", "响", "香", "箱", "乡", "详", "项"],
        "xiao" => &["小", "笑", "校", "消", "效", "销", "晓"],
        "xie"  => &["写", "些", "谢", "鞋", "血", "协", "斜", "携"],
        "xin"  => &["新", "心", "信", "辛", "欣", "薪", "芯"],
        "xing" => &["行", "性", "星", "形", "型", "姓", "兴", "幸", "刑", "醒"],
        "xiong"=> &["兄", "胸", "雄", "熊", "凶"],
        "xiu"  => &["修", "秀", "休", "袖", "绣", "嗅"],
        "xu"   => &["许", "续", "须", "需", "序", "虚", "蓄", "叙", "绪"],
        "xuan" => &["选", "宣", "悬", "旋", "玄", "喧"],
        "xue"  => &["学", "雪", "血", "穴", "靴"],
        "xun"  => &["训", "讯", "寻", "巡", "迅", "熏", "旬"],
        "ya"   => &["呀", "压", "牙", "雅", "亚", "鸭", "崖"],
        "yan"  => &["眼", "言", "烟", "严", "颜", "盐", "演", "沿", "岩", "验"],
        "yang" => &["样", "阳", "养", "洋", "央", "扬", "羊", "氧"],
        "yao"  => &["要", "药", "摇", "咬", "腰", "邀", "耀", "遥"],
        "ye"   => &["也", "夜", "叶", "页", "业", "野", "爷"],
        "yi"   => &["一", "已", "以", "意", "亿", "义", "易", "衣", "医", "依"],
        "yin"  => &["因", "音", "阴", "银", "引", "印", "饮", "隐"],
        "ying" => &["应", "影", "英", "营", "迎", "赢", "硬", "映", "樱"],
        "yong" => &["用", "永", "勇", "拥", "涌", "庸", "佣"],
        "you"  => &["有", "又", "右", "油", "友", "由", "游", "优", "邮", "犹"],
        "yu"   => &["于", "与", "鱼", "雨", "语", "玉", "域", "余", "预", "育"],
        "yuan" => &["元", "原", "远", "院", "员", "源", "园", "圆", "愿", "怨"],
        "yue"  => &["月", "越", "约", "阅", "悦", "岳", "乐"],
        "yun"  => &["云", "运", "允", "韵", "孕", "晕", "均"],
        "za"   => &["杂", "砸", "咱"],
        "zai"  => &["在", "再", "载", "灾", "宰"],
        "zan"  => &["咱", "赞", "暂", "攒"],
        "zao"  => &["早", "造", "遭", "糟", "灶", "澡", "枣"],
        "ze"   => &["则", "责", "择", "泽"],
        "zei"  => &["贼"],
        "zen"  => &["怎"],
        "zeng" => &["增", "曾", "赠", "憎"],
        "zha"  => &["扎", "炸", "渣", "闸", "乍", "眨"],
        "zhan" => &["站", "占", "战", "展", "斩", "沾", "盏"],
        "zhang"=> &["长", "张", "章", "掌", "丈", "涨", "账", "障"],
        "zhao" => &["找", "着", "照", "招", "赵", "罩", "朝"],
        "zhe"  => &["这", "着", "者", "折", "哲", "遮"],
        "zhen" => &["真", "镇", "阵", "针", "振", "震", "珍", "诊"],
        "zheng"=> &["正", "整", "政", "证", "争", "征", "睁", "蒸", "症"],
        "zhi"  => &["只", "知", "之", "直", "至", "制", "指", "纸", "值", "志"],
        "zhong"=> &["中", "重", "种", "众", "终", "钟", "忠", "仲"],
        "zhou" => &["周", "洲", "州", "舟", "轴", "皱", "粥"],
        "zhu"  => &["主", "住", "注", "朱", "助", "猪", "竹", "祝", "著", "柱"],
        "zhua" => &["抓", "爪"],
        "zhuan"=> &["转", "传", "专", "赚", "砖"],
        "zhuang"=> &["装", "状", "壮", "撞", "庄", "桩"],
        "zhui" => &["追", "坠", "缀", "锥"],
        "zhun" => &["准", "谆"],
        "zhuo" => &["着", "桌", "捉", "卓", "灼"],
        "zi"   => &["自", "子", "字", "紫", "资", "姿", "滋"],
        "zong" => &["总", "宗", "综", "纵", "棕", "踪"],
        "zou"  => &["走", "奏", "揍", "邹"],
        "zu"   => &["足", "组", "族", "祖", "阻", "租"],
        "zui"  => &["最", "醉", "嘴", "罪"],
        "zuo"  => &["做", "作", "坐", "左", "座", "昨"],
        _ => &[],
    };
    candidates.iter().map(|s| s.to_string()).collect()
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_split_simple() {
        assert_eq!(split_pinyin("nihao"), vec!["ni", "hao"]);
        assert_eq!(split_pinyin("zhongguo"), vec!["zhong", "guo"]);
        assert_eq!(split_pinyin("beijing"), vec!["bei", "jing"]);
    }

    #[test]
    fn test_split_greedy() {
        // "xian" 应该匹配为整体，不是 "xi" + "an"
        assert_eq!(split_pinyin("xian"), vec!["xian"]);
        assert_eq!(split_pinyin("zhuang"), vec!["zhuang"]);
    }

    #[test]
    fn test_engine() {
        let mut engine = PinyinEngine::new();
        engine.push('a');
        engine.push('i');
        assert_eq!(engine.syllables(), &["ai"]);
        let cands = engine.get_candidates();
        assert!(cands.contains(&"爱".to_string()));
    }

    #[test]
    fn test_engine_backspace() {
        let mut engine = PinyinEngine::new();
        for ch in "nihao".chars() { engine.push(ch); }
        assert_eq!(engine.syllables(), &["ni", "hao"]);
        engine.pop();
        engine.pop();
        assert_eq!(engine.syllables(), &["ni", "h"]);
    }
}
